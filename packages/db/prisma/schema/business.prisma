// =============================================
// ENTIDADES BASE - Cargos e Áreas
// =============================================

model Position {
  id         String   @id @default(cuid())
  name       String   @unique
  level      Int      @default(10) // DEPRECATED: migrar para HierarchyLevel
  canApprove Boolean  @default(false) // DEPRECATED: migrar para HierarchyLevel
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users     User[]
  providers Provider[]
  areas     AreaPosition[] // Áreas onde este cargo está disponível

  @@map("position")
}

// Níveis hierárquicos para fluxo de aprovação
model HierarchyLevel {
  id         String  @id @default(cuid())
  name       String  @unique
  level      Int     @unique // 10=Junior, 20=Pleno, ..., 80=Diretor, 90=Dir.RH, 95=CFO, 100=CEO
  canApprove Boolean @default(false)

  users     User[]
  providers Provider[]

  @@map("hierarchy_level")
}

model Area {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // C-level responsável pela área (visão executiva)
  cLevelId String?
  cLevel   User?   @relation("AreaCLevel", fields: [cLevelId], references: [id])

  // Diretor responsável pela área (aprovador de 1ª etapa)
  directorId String?
  director   User?   @relation("AreaDirector", fields: [directorId], references: [id])

  // Líder da área (pode abrir solicitações)
  leaderId String?
  leader   User?   @relation("AreaLeader", fields: [leaderId], references: [id])

  users        User[]         // Usuários desta área (1:N)
  providers    Provider[]
  bonusRecords BonusRecord[]
  positions    AreaPosition[] // Cargos disponíveis nesta área

  // Etapas de aprovação onde esta área é responsável
  approvalSteps ApprovalStep[] @relation("ApprovalStepArea")

  @@index([cLevelId])
  @@index([directorId])
  @@index([leaderId])
  @@map("area")
}

// Tabela de junção N:N entre Area e Position
model AreaPosition {
  areaId     String
  positionId String
  area       Area     @relation(fields: [areaId], references: [id], onDelete: Cascade)
  position   Position @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@id([areaId, positionId])
  @@map("area_position")
}

// =============================================
// PRESTADORES
// =============================================

model Provider {
  id              String         @id @default(cuid())
  name            String
  salary          Decimal        @db.Decimal(10, 2)
  startDate       DateTime       @db.Date
  seniority       Seniority      @default(NA)
  ndaStatus       DocumentStatus @default(NOT_SIGNED)
  ndaFileUrl      String?        // URL do PDF do NDA assinado (Vercel Blob)
  contractStatus  DocumentStatus @default(NOT_SIGNED)
  contractFileUrl String?        // URL do PDF do Contrato assinado (Vercel Blob)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Dados pessoais
  photoUrl    String?   // URL da foto 3x4 (Vercel Blob)
  birthDate   DateTime? @db.Date // Data de nascimento
  achievements String?  @db.Text // Feitos relevantes (texto livre)

  // Endereço
  addressStreet       String? // Rua/Logradouro
  addressNumber       String? // Número
  addressComplement   String? // Complemento
  addressNeighborhood String? // Bairro
  addressCity         String? // Cidade
  addressState        String? // Estado (UF)
  addressZipCode      String? // CEP

  // Relações
  areaId           String
  area             Area            @relation(fields: [areaId], references: [id])
  positionId       String
  position         Position        @relation(fields: [positionId], references: [id])
  hierarchyLevelId String?
  hierarchyLevel   HierarchyLevel? @relation(fields: [hierarchyLevelId], references: [id])

  // Relação opcional com usuário (se tiver login)
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Solicitações relacionadas a este prestador
  recessRequests       RecessRequest[]
  terminationRequests  TerminationRequest[]
  remunerationRequests RemunerationRequest[]

  // Substituições em contratações
  replacedByHirings HiringRequest[] @relation("ReplacedProvider")

  @@index([areaId])
  @@index([positionId])
  @@map("provider")
}

enum DocumentStatus {
  SIGNED
  NOT_SIGNED
}

enum Seniority {
  JUNIOR
  MID      // Pleno
  SENIOR
  LEAD
  PRINCIPAL
  NA       // Não aplicável (para cargos como Diretor, CEO, etc.)
}

// =============================================
// SOLICITAÇÕES - Enums comuns
// =============================================

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum ApprovalRole {
  AREA_DIRECTOR
  HR_DIRECTOR
  CFO
  CEO
  PARTNER
}

enum TerminationType {
  RESIGNATION // Pedido de demissão (prestador pediu)
  DISMISSAL   // Demissão (empresa demitiu)
}

// =============================================
// MÓDULO: RECESSO / FÉRIAS
// =============================================

model RecessRequest {
  id           String        @id @default(cuid())
  status       RequestStatus @default(PENDING)
  startDate    DateTime      @db.Date
  endDate      DateTime      @db.Date
  daysCount    Int           // Calculado: endDate - startDate + 1
  reason       String?       @db.Text
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Snapshot dos dados do prestador no momento da criação
  providerArea     String
  providerPosition String

  // Relações
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])
  creatorId  String
  creator    User     @relation(fields: [creatorId], references: [id])

  // Etapas de aprovação
  approvalSteps ApprovalStep[]

  @@index([providerId])
  @@index([creatorId])
  @@index([status])
  @@map("recess_request")
}

// =============================================
// MÓDULO: DESLIGAMENTO
// =============================================

model TerminationRequest {
  id              String          @id @default(cuid())
  status          RequestStatus   @default(PENDING)
  terminationType TerminationType
  terminationDate DateTime        @db.Date
  reason          String          @db.Text // Obrigatório, mínimo 10 caracteres
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Snapshot dos dados do prestador no momento da criação
  providerArea     String
  providerPosition String
  providerSalary   Decimal         @db.Decimal(10, 2)

  // Relações
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])
  creatorId  String
  creator    User     @relation(fields: [creatorId], references: [id])

  // Etapas de aprovação
  approvalSteps ApprovalStep[]

  @@index([providerId])
  @@index([creatorId])
  @@index([status])
  @@map("termination_request")
}

// =============================================
// MÓDULO: CONTRATAÇÃO
// =============================================

model HiringRequest {
  id                String        @id @default(cuid())
  status            RequestStatus @default(PENDING)
  hiringType        HiringType
  proposedSalary    Decimal       @db.Decimal(10, 2)
  expectedStartDate DateTime      @db.Date
  priority          Priority
  reason            String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Status pós-aprovação
  hiringStatus     HiringStatus @default(WAITING)
  hiredName        String?      // Nome preenchido quando contratado
  actualStartDate  DateTime?    @db.Date // Data real de início

  // Relações
  areaId     String
  area       String // Nome da área (snapshot)
  positionId String
  position   String // Nome do cargo (snapshot)
  creatorId  String
  creator    User   @relation(fields: [creatorId], references: [id])

  // Substituição (opcional)
  replacedProviderId String?
  replacedProvider   Provider? @relation("ReplacedProvider", fields: [replacedProviderId], references: [id])

  // Etapas de aprovação
  approvalSteps ApprovalStep[]

  @@index([creatorId])
  @@index([status])
  @@index([hiringStatus])
  @@map("hiring_request")
}

enum HiringType {
  INCREASE    // Aumento de Quadro
  REPLACEMENT // Substituição
}

enum HiringStatus {
  WAITING     // Aguardando
  IN_PROGRESS // Em Andamento
  HIRED       // Contratado
}

// =============================================
// MÓDULO: SOLICITAÇÃO DE COMPRA
// =============================================

model PurchaseRequest {
  id          String        @id @default(cuid())
  status      RequestStatus @default(PENDING)
  description String        // Nome da Despesa/Serviço
  value       Decimal       @db.Decimal(10, 2)
  paymentDate DateTime      @db.Date
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Snapshot dos dados do solicitante
  requesterArea     String
  requesterPosition String

  // Relações
  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id])

  // Etapas de aprovação
  approvalSteps ApprovalStep[]

  @@index([creatorId])
  @@index([status])
  @@map("purchase_request")
}

// =============================================
// MÓDULO: MUDANÇA DE REMUNERAÇÃO
// =============================================

model RemunerationRequest {
  id            String        @id @default(cuid())
  status        RequestStatus @default(PENDING)
  currentSalary Decimal       @db.Decimal(10, 2) // Snapshot do salário atual
  newSalary     Decimal       @db.Decimal(10, 2)
  effectiveDate DateTime      @db.Date
  priority      Priority
  reason        String        @db.Text // Obrigatório
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Snapshot dos dados do prestador no momento da criação
  providerArea     String
  providerPosition String

  // Relações
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])
  creatorId  String
  creator    User     @relation(fields: [creatorId], references: [id])

  // Etapas de aprovação
  approvalSteps ApprovalStep[]

  @@index([providerId])
  @@index([creatorId])
  @@index([status])
  @@map("remuneration_request")
}

// =============================================
// SISTEMA DE APROVAÇÃO
// =============================================

model ApprovalStep {
  id           String        @id @default(cuid())
  stepNumber   Int           // 1, 2, 3, 4
  role         ApprovalRole  // DEPRECATED: mantido para compatibilidade
  status       RequestStatus @default(PENDING)
  comment      String?       @db.Text // Obrigatório em rejeições
  approvedAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Área responsável por aprovar esta etapa (novo sistema baseado em áreas)
  approvalAreaId String?
  approvalArea   Area?   @relation("ApprovalStepArea", fields: [approvalAreaId], references: [id])

  // Quem aprovou/rejeitou
  approverId String?
  approver   User?   @relation(fields: [approverId], references: [id])

  // Relações com cada tipo de solicitação (apenas uma será preenchida)
  recessRequestId       String?
  recessRequest         RecessRequest?       @relation(fields: [recessRequestId], references: [id], onDelete: Cascade)
  terminationRequestId  String?
  terminationRequest    TerminationRequest?  @relation(fields: [terminationRequestId], references: [id], onDelete: Cascade)
  hiringRequestId       String?
  hiringRequest         HiringRequest?       @relation(fields: [hiringRequestId], references: [id], onDelete: Cascade)
  purchaseRequestId     String?
  purchaseRequest       PurchaseRequest?     @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)
  remunerationRequestId String?
  remunerationRequest   RemunerationRequest? @relation(fields: [remunerationRequestId], references: [id], onDelete: Cascade)

  @@index([approverId])
  @@index([approvalAreaId])
  @@index([recessRequestId])
  @@index([terminationRequestId])
  @@index([hiringRequestId])
  @@index([purchaseRequestId])
  @@index([remunerationRequestId])
  @@map("approval_step")
}

// =============================================
// MÓDULO: FOLHA - BÔNUS
// =============================================

model BonusRecord {
  id        String    @id @default(cuid())
  year      Int
  month     Int       // 1-12
  tier      BonusTier
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  areaId String
  area   Area   @relation(fields: [areaId], references: [id])

  @@unique([areaId, year, month])
  @@index([year, month])
  @@map("bonus_record")
}

enum BonusTier {
  NONE   // 0%
  BRONZE // 10%
  SILVER // 15%
  GOLD   // 20%
}

// =============================================
// AUDITORIA
// =============================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // CREATE, UPDATE, DELETE, APPROVE, REJECT, LOGIN, LOGOUT, VIEW
  entityType String   // User, Provider, RecessRequest, etc.
  entityId   String?
  details    Json?    // Dados adicionais (before/after para edições)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_log")
}

// =============================================
// CONFIGURAÇÕES DO SISTEMA
// =============================================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}
